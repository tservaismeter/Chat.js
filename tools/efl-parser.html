<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EFL Parser</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-2xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">EFL Parser</h1>

    <!-- Upload Section -->
    <div id="upload-section" class="bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Upload EFL PDF</h2>
      <input type="file" id="file-input" accept=".pdf" class="block w-full text-sm text-gray-500
        file:mr-4 file:py-2 file:px-4
        file:rounded-full file:border-0
        file:text-sm file:font-semibold
        file:bg-blue-50 file:text-blue-700
        hover:file:bg-blue-100 mb-4" />
      <div class="text-center text-gray-500 my-2">— OR —</div>
      <input type="url" id="url-input" placeholder="https://example.com/efl.pdf" class="w-full border rounded px-3 py-2 mb-4" />
      <button id="parse-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50">
        Parse EFL
      </button>
      <div id="loading" class="hidden mt-4 text-gray-600">
        <svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Parsing PDF...
      </div>
      <div id="error" class="hidden mt-4 text-red-600 bg-red-50 p-3 rounded"></div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="hidden bg-white rounded-lg shadow p-6 mb-6">
      <h2 class="text-xl font-semibold mb-4">Extracted Data</h2>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Retailer</label>
          <input type="text" id="retailer-name" class="w-full border rounded px-3 py-2 bg-gray-50" readonly />
          <input type="hidden" id="retailer-id" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">PUCT Number</label>
          <input type="text" id="puct-number" class="w-full border rounded px-3 py-2 bg-gray-50" readonly />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Utility</label>
          <input type="text" id="utility-name" class="w-full border rounded px-3 py-2 bg-gray-50" readonly />
          <input type="hidden" id="utility-id" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
          <input type="text" id="plan-name" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Term (months)</label>
          <input type="number" id="term-months" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Energy Rate (cents/kWh)</label>
          <input type="number" step="0.0001" id="energy-rate" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Base Fee ($)</label>
          <input type="number" step="0.01" id="base-fee" class="w-full border rounded px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">ETF ($)</label>
          <input type="number" step="0.01" id="etf" class="w-full border rounded px-3 py-2" placeholder="Leave empty if none" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Renewable %</label>
          <input type="number" id="renewable-percent" class="w-full border rounded px-3 py-2" min="0" max="100" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Signup URL</label>
          <input type="url" id="signup-url" class="w-full border rounded px-3 py-2" placeholder="Optional" />
        </div>
      </div>

      <div id="existing-plan-warning" class="hidden bg-yellow-50 border border-yellow-200 p-3 rounded mb-4">
        <strong>Existing plan found!</strong> Saving will update the existing plan.
      </div>

      <div class="flex gap-4">
        <button id="save-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
          Save Plan
        </button>
        <button id="reset-btn" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400">
          Reset
        </button>
      </div>

      <div id="save-loading" class="hidden mt-4 text-gray-600">
        <svg class="animate-spin h-5 w-5 inline mr-2" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
      </div>
      <div id="save-success" class="hidden mt-4 text-green-600 bg-green-50 p-3 rounded"></div>
      <div id="save-error" class="hidden mt-4 text-red-600 bg-red-50 p-3 rounded"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://amlbrptgggmwdwdxltlj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtbGJycHRnZ2dtd2R3ZHhsdGxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQxNDQxMjAsImV4cCI6MjA1OTcyMDEyMH0.x8rJBcqF9EcX7Ja1npxIXDmsvUJ3wQwD-gVvHDI7Q2A';

    let currentData = null;

    document.getElementById('parse-btn').addEventListener('click', parseEFL);
    document.getElementById('save-btn').addEventListener('click', savePlan);
    document.getElementById('reset-btn').addEventListener('click', reset);

    async function parseEFL() {
      const fileInput = document.getElementById('file-input');
      const urlInput = document.getElementById('url-input').value.trim();
      const file = fileInput.files[0];

      if (!file && !urlInput) {
        showError('Please select a PDF file or enter a URL');
        return;
      }

      showLoading(true);
      hideError();

      const formData = new FormData();
      if (urlInput) {
        formData.append('url', urlInput);
      } else {
        formData.append('file', file);
      }

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/parse-efl`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'apikey': SUPABASE_KEY,
          },
          body: formData,
        });

        const text = await response.text();
        console.log('Response status:', response.status);
        console.log('Response text:', text);

        if (!response.ok) {
          showError(`HTTP ${response.status}: ${text}`);
          return;
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          showError('Invalid JSON response: ' + text.substring(0, 200));
          return;
        }

        if (data.error) {
          showError(JSON.stringify(data, null, 2));
          return;
        }

        currentData = data;
        displayResults(data);
      } catch (err) {
        showError('Failed to parse EFL: ' + err.message);
      } finally {
        showLoading(false);
      }
    }

    function displayResults(data) {
      const { extracted, retailer, utility, existingPlan } = data;

      const retailerDisplay = retailer?.name || extracted.retailer_name;
      document.getElementById('retailer-name').value = data.isNewRetailer
        ? retailerDisplay + ' (NEW)'
        : retailerDisplay;
      document.getElementById('retailer-id').value = retailer?.id || '';
      document.getElementById('puct-number').value = extracted.puct_number;
      document.getElementById('utility-name').value = utility?.name || extracted.utility_code + ' (NOT FOUND)';
      document.getElementById('utility-id').value = utility?.id || '';
      document.getElementById('plan-name').value = extracted.plan_name;
      document.getElementById('term-months').value = extracted.term_months;
      document.getElementById('energy-rate').value = extracted.energy_rate_cents;
      document.getElementById('base-fee').value = extracted.base_fee_dollars;
      document.getElementById('etf').value = extracted.etf_dollars || '';
      document.getElementById('renewable-percent').value = extracted.renewable_percent || 0;

      if (existingPlan) {
        document.getElementById('existing-plan-warning').classList.remove('hidden');
        document.getElementById('signup-url').value = existingPlan.signup_url || '';
      } else {
        document.getElementById('existing-plan-warning').classList.add('hidden');
      }

      document.getElementById('results-section').classList.remove('hidden');

      // Disable save if utility not found (retailers are auto-created now)
      const saveBtn = document.getElementById('save-btn');
      if (!utility) {
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-50');
        showError('Cannot save: Utility not found in database');
      } else {
        saveBtn.disabled = false;
        saveBtn.classList.remove('opacity-50');
      }
    }

    async function savePlan() {
      const retailerId = document.getElementById('retailer-id').value;
      const utilityId = document.getElementById('utility-id').value;

      if (!retailerId || !utilityId) {
        document.getElementById('save-error').textContent = 'Missing retailer or utility ID';
        document.getElementById('save-error').classList.remove('hidden');
        return;
      }

      document.getElementById('save-loading').classList.remove('hidden');
      document.getElementById('save-error').classList.add('hidden');
      document.getElementById('save-success').classList.add('hidden');

      const planData = {
        extracted: {
          plan_name: document.getElementById('plan-name').value,
          term_months: parseInt(document.getElementById('term-months').value),
          energy_rate_cents: parseFloat(document.getElementById('energy-rate').value),
          base_fee_dollars: parseFloat(document.getElementById('base-fee').value),
          etf_dollars: document.getElementById('etf').value ? parseFloat(document.getElementById('etf').value) : null,
          renewable_percent: parseInt(document.getElementById('renewable-percent').value) || 0,
        },
        retailer_id: parseInt(retailerId),
        utility_id: parseInt(utilityId),
        tempPdfPath: currentData.tempPdfPath,
        originalFilename: currentData.originalFilename,
        existingPlanId: currentData.existingPlan?.id,
        signup_url: document.getElementById('signup-url').value,
      };

      const formData = new FormData();
      formData.append('action', 'save');
      formData.append('plan', JSON.stringify(planData));

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/parse-efl`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'apikey': SUPABASE_KEY,
          },
          body: formData,
        });

        const result = await response.json();

        if (result.error) {
          document.getElementById('save-error').textContent = result.error;
          document.getElementById('save-error').classList.remove('hidden');
        } else {
          document.getElementById('save-success').textContent = `Plan saved successfully! ID: ${result.plan.id}`;
          document.getElementById('save-success').classList.remove('hidden');
        }
      } catch (err) {
        document.getElementById('save-error').textContent = 'Failed to save: ' + err.message;
        document.getElementById('save-error').classList.remove('hidden');
      } finally {
        document.getElementById('save-loading').classList.add('hidden');
      }
    }

    function reset() {
      currentData = null;
      document.getElementById('file-input').value = '';
      document.getElementById('url-input').value = '';
      document.getElementById('results-section').classList.add('hidden');
      document.getElementById('save-success').classList.add('hidden');
      document.getElementById('save-error').classList.add('hidden');
      hideError();
    }

    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
      document.getElementById('parse-btn').disabled = show;
    }

    function showError(msg) {
      const el = document.getElementById('error');
      el.textContent = msg;
      el.classList.remove('hidden');
    }

    function hideError() {
      document.getElementById('error').classList.add('hidden');
    }
  </script>
</body>
</html>
